\documentclass[12pt]{article}
\usepackage{fullpage}%varioref,multicol

%\topmargin 0.25in
\usepackage{bm}
%\usepackage{latexsym}
\usepackage{amsmath,amssymb}
%\usepackage{amssymb,amsbsy,exscale,amsmath,amsfonts,amssymb,amscd}
\usepackage{amsthm}
\usepackage{wrapfig}
\usepackage{epsfig}
\usepackage{graphicx}
\usepackage{makeidx}
\usepackage{multicol}
\usepackage{tikz}
\usepackage{algorithm}
\usepackage{algpseudocode}
\usepackage{soul}

%\usepackage{subeqn}
%\usepackage{crop}
%\crop
\newcommand{\pr}{\mathrm{pr}}
\newcommand{\du}{\mathrm{du}}
\newcommand{\RR}{{\mathbb R}}
\newcommand{\K}{{\mathcal K}}
\newcommand{\T}{{\mathbb T}}
\newcommand{\Em}{{\mbox{\small \,${\rm E}$\,--\,}}}
\newcommand{\Ep}{{\mbox{\small \,${\rm E}$\,+\,}}}
\newcommand{\N}{{\cal N}}
\newcommand{\M}{{\cal M}}
\newcommand{\D}{{\cal D}}
\newcommand{\I}{{\mathbb I}}
\newcommand{\refeq}[1]{(\ref{#1})}
\newcommand{\R}{I\hspace{-1ex}R}
\newtheorem{thm}{Theorem}
\newtheorem{lem}[thm]{Lemma}
\newcommand{\ex}{{\rm ex}}
\newcommand{\bk}{{\rm bk}}
\newcommand{\df}{{\rm df}}
\newcommand{\std}{{\rm std}}
\newcommand{\cov}{{\rm cov}}
\newcommand{\true}{{\rm true}}
%\makeindex


% definitions used by included articles, reproduced here for
% educational benefit, and to minimize alterations needed to be made
% in developing this sample file.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\graphicspath{{../../figures/}}
%\DeclareGraphicsExtensions{.jpg,.png,.mps,.pdf}
\DeclareGraphicsRule{*}{mps}{*}{}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%Define shortcuts
\newcommand{\del}[2]{\frac{\partial #1}{\partial #2}}
\newcommand{\ddel}[2]{\dfrac{\partial #1}{\partial #2}}
\def\mathbi#1{\textbf{\em #1}}

\newcommand\rev[1]{\textcolor{black}{#1}}
\newcommand\revisePF[1]{\textcolor{red}{#1}}

\newcommand{\bs}[1]{\boldsymbol{#1}}
\newcommand{\bmu}{\bs{\mu}}

\usepackage{tabularx}
\usepackage{booktabs}


\begin{document}


\title{MDP.jl: Summary of the Implemented Equations - Draft}

\date{\today}

%
\maketitle

\begin{abstract}
This draft presents a summary of the equations that are currently implemented in MDP.jl (and its auxiliary files). It is based on the file GOLFF.pdf (project name changed from GOLFF.jl to MDP.jl). 
Some of the terminology was slightly redefined in order to smooth the transition between the original equations and their computational implementation.
\end{abstract}

\section{Input Variables/Parameters}

The following table shows all the relevant input variables or parameters needed in the computational implementation. As mentioned above, some of them were slightly redefined and new definitions were added. 

\begin{center}
    \label{table:def}
    \begin{tabular}{ | l | p{7.5cm} | l | p{7.5cm} |}
    \hline
    $J$ & Number of configurations. & $\Omega_{ji}$ & Neighbors of the atom $i$ in configuration $j$. \\ \hline
    
    $N_j$ & Number of atoms in configuration $j$. & $\Omega'_{jit}$ & Neighbors of the atom $i$ in configuration $j$, whose atomic number type is $t$. \\ \hline
    
    $Z_{ji}$ & Atomic number of atom $i$ in configuration $j$. & $\Omega''_{jit}$ & If the atomic number type of $i$ is $t$, returns the neighbors of the atom $i$ in configuration $j$, else it returns empty. \\ \hline
    
    $T_z$ & Type of the atomic number z. Each atomic number z is indexed in T. & $\Omega'''_{jt}$ & Atoms in configuration $j$, whose atomic number type is $t$. \\ \hline
    
    $N_z$ & Number of the different atomic numbers (or atomic number types) present in all configurations. &  L, K &  \\ \hline
    
    $\bm {r}^{N_j}_{i}$ & Position of atom $i$ in the configuration $j$. & M & Number of basis functions.\\ \hline
    
    $\bm {r}^{N_j}$ & Positions of all the atoms in configuration $j$ ($N_j \times 3$). & $c_{tkk'l}$  & Coefficient needed to calculate the potential/force. A linearized version $c_{m}$ was finally used. See Equation \ref{eq:force}.\\ \hline %[1ex]
    
    $\bm f^{\rm qm}_{ji}$ & Quantum force associated to the atom $i$ in the configuration $j$. & $w_j$ & Weight associated to the configuration j. \\ \hline
    
    $r_{\rm cut}$ & Cut radius needed to calculate the neighbors of each atom. &  $h$ & Finite difference increment. \\
    \hline
    \end{tabular}
\end{center}

\section{Equation Summary}
\subsection{Main goal}

The goal is to find an optimal coefficient vector $\bm c^*$ to match a set of input quantum mechanical (QM) forces. The optimization problem is formulated in the Equation 4 of the original manuscript. Here, the problem is formulated as follows:

\begin{equation}
\bm c^* = \arg \min_{\bm c \in \mathbb{R}^M } \sum_{j=1}^J w_j \sum_{i=1}^{N_j}  \left|\bm f(\bm {r}^{N_j}, \bm c, j, i) - \bm f^{\rm qm}(\bm r^{N_j}, j, i) \right|^2.
\label{eq:min1}
\end{equation}

where $w_j$ are the user-defined weights in configuration $j$, $1 \le j \le J$, the default value of $w_j$ is 1. $\bm f$  depicts a (complex) atomic force, the definition of which can be found below. The value of this force depends on the configuration $j$, the atom $i$ in the $j$-th configuration, the position of all atoms in the $j$-th configuration $\bm {r}^{N_j}$, and the variable for which the minimization is performed $c$. An analogous description is associated to the input QM forces $\bm f^{\rm qm}$, with the exception of the dependence of variable $c$.

The atomic force $\bm f$ is defined in the original manuscript in Equations 4 and 5. This atomic force is calculated through a set of basis functions. In particular, the power spectrum  and bispectrum basis functions are considered.

The atomic force calculated through the power basis functions $d_{tkk'l}(\bm r^{N_j}, j, i)$ is formulated as follows:

\begin{equation}
    \bm f(\bm {r}^{N_j}, \bm c, j, i) = 
    \sum_{t=1}^{N_z}
    \sum_{k=1}^K
    \sum_{k'=k}^{K}
    \sum_{l=0}^L
    c_{tkk'l}
    \frac{\partial d_{tkk'l}(\bm r^{N_j}, j, i)}{\partial \bm r^{N_j}_i}
    \label{eq:force}
\end{equation}


On the other hand, the atomic force calculated through the bispectrum basis functions $d_{jkk'l{l_1}{l_2}}(\bm r^{N_j}, j, i)$ is formulated as follows:

\begin{equation}
    \bm f(\bm {r}^{N_j}, \bm c, j, i) = 
    \sum_{t=1}^{N_z}
    \sum_{k=1}^K
    \sum_{k'=k}^{K}
    \sum_{l=0}^L
    \sum_{l_1=0}^L
    \sum_{l_2=0}^L
    c_{tkk'l{l_1}{l_2}}
    \frac{\partial d_{tkk'l{l_1}{l_2}}(\bm r^{N_j}, j, i)}{\partial \bm r^{N_j}_i}
    \label{eq:force}
\end{equation}

Note that $ \frac{\partial d_{tkk'l}(\bm r^{N^j}, j, i)}{\partial \bm r_i}$ and $ \frac{\partial d_{tkk'l{l_1}{l_2}}(\bm r^{N^j}, j, i)}{\partial \bm r_i}$
 are the gradient vectors of $d_{tkk'l}$ and $d_{jkk'l{l_1}{l_2}}$, respectively, varying with respect to the position of the $i$-th atom in the $j$-configuration, i.e. $f$ is a vector quantity.


Returning to equation \ref{eq:min1}, current Julia implementation uses ``GalacticOptim'' package to perform the optimization. In the computational implementation $c_{tkk'l}$ and $c_{jkk'l{l_1}{l_2}}$ had to be linearized due to interface compatibility with the optimization library. The new coefficient is $c_{m}$, where the index $m$ is just a one-dimension unrolling of the tuple index $t$,$k$,$k'$,$l$, or $j$,$k$,$k'$,$l$,$l_1$,$l_2$. Therefore, $c \in \mathbb{R}^M$.

In future versions, neural networks will be used to perform the optimization.

\subsection{Power basis functions}

The following functions are based on the quantum theory of angular momentum. The derivatives of the power basis functions are defined in Equations 23 and 24 in the original manuscript. Here, it is formulated as:

\begin{equation}
    \label{eq:derd}
    \frac{\partial d_{tkk'l}(\bm r^{N_j}, j, i)}{\partial \bm r^{N_j}_i} = \sum_{s \in \Omega'_{jit}} p_{iskk'l}^{\partial}(\bm r^{N_j}, j) - \sum_{s \in \Omega''_{jit}} p_{sikk'l}^{\partial} ( \bm r^{N_j}, j),
\end{equation}
where 
\begin{equation}
    p_{i_0i_1kk'l}^{\partial}(\bm r^{N_j}, j) = \sum_{m=-l}^l \left( \frac{\partial u_{klm}(\bm r_{i_0}^{N_j}- \bm r_{i_1}^{N_j})}{\partial (\bm r_{i_0}^{N_j}-\bm r_{i_1}^{N_j})} \sum_{s \in \Omega_{j,i_1}} \left( u_{k'lm} (\bm r^{N_j}_s- \bm r^{N_j}_{i_1}) \right) \right) + 
\end{equation}
\begin{equation*}
\sum_{m=-l}^l \left( \frac{\partial u_{k'lm}(\bm r_{i_0}^{N_j}- \bm r_{i_1}^{N_j})}{\partial (\bm r_{i_0}^{N_j}- \bm r_{i_1}^{N_j})} \sum_{s \in \Omega_{j,i_1}} \left( u_{klm} (\bm r^{N_j}_s- \bm r^{N_j}_{i_1}) \right) \right)
\end{equation*}

$\Omega$, $\Omega'$, and $\Omega''$ were introduced to simplify the notation and to have precomputed neighbor information. Two atoms, $s$ and $q$, are neighbours if $s \ne q$ and $|| \bm r_s^{N_j} - \bm r_q^{N_j} || \le r_{\rm cut} $ \textbf{but this must take into account the periodic boundary conditions}. 

The derivative of the (complex) function $u_{klm}$ is not present in the original manuscript. Here, it is computed through the finite difference method.

\begin{equation}
\begin{split}
     \frac{\partial u_{klm}(\bm r)}{\partial (\bm r)} =  
        \bigg( \frac{ u_{klm}(\bm r + \bm \Delta x) - u_{klm}(\bm r - \bm \Delta x) } {2 |\bm \Delta x|}, \\
          \frac{ u_{klm}(\bm r + \bm \Delta y) - u_{klm}(\bm r - \bm \Delta y) } {2 |\bm \Delta y|},\\
          \frac{ u_{klm}(\bm r + \bm \Delta z) - u_{klm}(\bm r - \bm \Delta z) } {2 |\bm \Delta z|} \bigg)
\end{split}
\end{equation}

where $\bm \Delta x = (h, 0, 0)$, $\bm \Delta y = (0, h, 0)$, and $\bm \Delta z = (0, 0, h)$.

The function $u_{klm}: \mathbb{R}^3 \rightarrow \mathbb{C}$ is defined in the Equation 11. Here, it is formulated as

\begin{equation}
    \label{eq:us}
    u_{klm}(\bm r) =  g_{lk}(r) Y_{lm}(\theta,\phi)
\end{equation}

Note that $\bm r$ is expressed in cartesian coordinates $(x,y,z)$, but spherical coordinates are needed to invoke $g_{lk}$ and $Y_{lm}$. Then, the following transformations are used:

\begin{equation*}
    r = \sqrt{x^2 + y^2 + z^2}
\end{equation*}
\begin{equation*}
    \theta = \arccos(z/r)    
\end{equation*}
\begin{equation*}
    \phi = \text{atan}(y,x) \footnote{Use the Julia atan function with two arguments ($y$,$x$) that returns the angle in radians between the positive $x$-axis and the point $(x, y)$ in the interval $[-\pi, \pi]$.}
\end{equation*}

In Equation \ref{eq:us}, $g_{lk}$ is a radial basis functions. Currently, the Julia spherical Bessel function ``sphericalbessely'' is used. Other functions should be implemented in the future, including polynomials and Gaussian functions.

Returning to Equation \ref{eq:us}, the spherical harmonics of degree $l$ and order $m$ ($Y_{lm}$) is presented in Equation 12 in the original manuscript. Here, it is formulated as
\begin{equation}
 Y_{lm}(\theta,\phi) = \sqrt{\frac{(2l + 1)}{4 \pi} \frac{(l-m)!}{(l+m)!}} P_{lm}(\cos(\theta)) e^{i m \phi}
\end{equation}
$P_{lm}$ are the associated Legendre polynomials. They are not included in the original manuscript. Here, the following expressions are used:

\begin{equation}
    \label{eq:leg4}
    P_{lm}(x) = (-1)^m (1-x^2)^{m/2} \Bigg( \frac{1}{2!} \sum_{k=\lceil \frac{l+m}{2} \rceil}^l  (-1)^{l-k} {l \choose k} {2k \choose l} \frac{(2k-l)!}{(2k-l-m)!} x^{2k-l-m} \Bigg) \quad m >0
\end{equation}

\begin{equation}
    \label{eq:leg2}
    P_{lm} (x) = (-1)^{|m|} \frac{(l-|m|)!}{(l+|m|)!} P_{l|m|} \quad m < 0
\end{equation}

\begin{equation}
    \label{eq:leg5}
    P_{lm}(x) = P_l(x) \quad m = 0
\end{equation} 


$P_l$ is the Legendre polynomial of degree $l$ given by:
\begin{equation}
    \label{eq:fleg2}
    P_l(x) = \frac{1}{2^l} \sum_{k=\lceil l/2 \rceil}^l {l \choose k} (-1)^{l-k} {2k \choose l} x^{2k-l}
\end{equation}

A derivation of the expressions above are presented in the Appendix.

\subsection{Bispectrum basis functions}

The derivatives of the bispectrum basis functions are not presented in the original mansucript. Here, we use the finite difference method:

\begin{equation}
\begin{split}
     \frac{\partial d_{tkk'l{l_1}{l_2}}(\bm r^{N_j}, j, i)}{\partial \bm r^{N_j}_i} =  
 \bigg( \frac{ d_{tkk'l{l_1}{l_2}}(\bm r^{N_j} + \bm \Delta X_i, j, i) - d_{tkk'l{l_1}{l_2}}(\bm r^{N_j} - \bm \Delta X_i, j, i) } {2 |\bm \Delta X_i|}, \\
          \frac{ d_{tkk'l{l_1}{l_2}}(\bm r^{N_j} + \bm \Delta Y_i, j, i) - d_{tkk'l{l_1}{l_2}}(\bm r^{N_j} - \bm \Delta Y_i, j, i) } {2 |\bm \Delta Y_i|},\\
          \frac{ d_{tkk'l{l_1}{l_2}, j, i}(\bm r^{N_j} + \bm \Delta Z_i, j, i) - d_{tkk'l{l_1}{l_2}, j, i}(\bm r^{N_j} - \bm \Delta Z_i, j, i) } {2 |\bm \Delta Z_i|} \bigg)
\end{split}
\end{equation}

where $\bm \Delta X_i$, $\bm \Delta Y_i$, and $\bm \Delta Z_i$ are vectors of the same size as $r^{N_j}$, containing $(0,0,0)$ in all their components except for the $i$-$th$ component, which is equal to $\bm \Delta x$, $\bm \Delta y$, and $\bm \Delta z$, respectively. E.g. if the size of $r^{N_j}$ is $3$ and $i = 2$, then $\bm \Delta X_2 = ( (0,0,0), \bm \Delta x, (0,0,0))$.

The bispectrum basis functions are defined in Equations 29 and 30 in the original manuscript. Here, it is formulated as:

\begin{equation}
    \label{eq:derd}
    d_{tkk'l{l_1}{l_2}}(\bm r^{N_j}, j, i) = \sum_{s \in \Omega'''_{jt}} b_{skk'l{l_1}{l_2}}(\bm r^{N_j}, j, i)
\end{equation}

where 

\begin{equation}
    b_{skk'l{l_1}{l_2}}(\bm r^{N_j}, j, i) = 
     \sum_{m=-l}^l
     \sum_{m_1=-{l_1}}^{l_1}
     \sum_{m_2=-l_2}^{l_2}
     \bar{a}_{sklm}(\bm r^{N_j}, j)
     C_{{m_1}{m_2}m}^{{l_1}{l_2}l}
     a_{sk'{l_1}{m_1}}(\bm r^{N_j}, j)
     a_{sk'{l_2}{m_2}}(\bm r^{N_j}, j)
\end{equation}

\begin{equation}
    a_{iklm}(\bm r^{N_j}, j) = \sum_{s \in \Omega_{ji}} u_{klm}(\bm r^{N_j}_s -\bm r^{N_j}_i)
\end{equation}


In the computer code, the Clebsch–Gordan coefficients, $C_{{m_1}{m_2}m}^{{l_1}{l_2}l}$, are computed through the library ``PartialWaveFunctions.jl''.


\begin{appendix}
\section{Associated Legendre polynomials}
\label{app:legendre}

The associated Legendre polynomials are defined as:

\begin{equation}
    \label{eq:leg}
    P_{lm}(x) = (-1)^m (1-x^2)^{m/2}  \frac{\mathrm{d}^m}{\mathrm{d}x^m} P_l(x), \ if \ m \ge 0
\end{equation}
\begin{equation}
    \label{eq:leg2}
    P_{lm} (x) = (-1)^{|m|} \frac{(l-|m|)!}{(l+|m|)!} P_{l|m|}, \ if \ m < 0
\end{equation}
$P_l$ is the Legendre polynomial of degree $l$ given by:
\begin{equation}
    \label{eq:leg3}
    P_l(x)=\frac{1}{2^l l!} \frac{\mathrm{d}^l}{\mathrm{d}x^l}(x^2-1)^l
\end{equation}

By combining Equations \ref{eq:leg} and \ref{eq:leg3}, we obtain the following expressions for $P_{lm}(x)$, $l \ge 0$, $0 \le m \le l$ (Equations \ref{eq:leg4} and \ref{eq:leg5}). The case $-l \le m <0$ follows from Equation \ref{eq:leg2}. 

\begin{equation}
    \label{eq:leg4}
    P_{lm}(x) = (-1)^m (1-x^2)^{m/2} \Bigg( \frac{1}{2!} \sum_{k=\lceil \frac{l+m}{2} \rceil}^l  (-1)^{l-k} {l \choose k} {2k \choose l} \frac{(2k-l)!}{(2k-l-m)!} x^{2k-l-m} \Bigg), \quad m >0
\end{equation}
\begin{equation}
    \label{eq:leg5}
    P_{lm}(x) = P_l(x)  \quad m = 0.
\end{equation} 
In Equation \ref{eq:leg4}, $\lceil . \rceil$ denotes the ceiling function.

    
A derivation of Equation \ref{eq:leg4} from the definitions of Legendre polynomials (Equation \ref{eq:leg3}) and associated Legendre polynomials (Equation \ref{eq:leg}) is presented below.

By applying the binomial theorem:
\begin{equation}
    \label{eq:fleg}
    P_l(x)= \frac{1}{2^l l!} \frac{\mathrm{d}^l}{\mathrm{d}x^l}(x^2-1)^l = \frac{1}{2^l l!} \sum_{k=0}^l {l \choose k} (-1)^{l-k} \frac{\mathrm{d}^l}{\mathrm{d}x^l}(x^{2k}).
\end{equation}

The $l$-th derivative of $x^{2k}$ can be written as:

\[ \frac{\mathrm{d}^l}{\mathrm{d}x^l}(x^{2k}) =
  \begin{cases}
    2k (2k-1) \ldots (2k-l+1) x^{2k-l}      & \quad \text{if } 2k \ge l \\
    0 & \quad \text{if } 2k < l
  \end{cases}
\]

Therefore, replacing the derivative in Equation \ref{eq:fleg}:
\begin{equation*}
    P_l(x) = \frac{1}{2^l} \sum_{k=\lceil l/2 \rceil}^l {l \choose k} (-1)^{l-k} \frac{(2k)!}{(2k-l)! l!} x^{2k-l}
\end{equation*}
\begin{equation}
    \label{eq:fleg2}
    P_l(x) = \frac{1}{2^l} \sum_{k=\lceil l/2 \rceil}^l {l \choose k} (-1)^{l-k} {2k \choose l} x^{2k-l}
\end{equation}

We proceed in a similar way to obtain the $m$-th derivative of $P_l(x)$ for $0 < m \le l$ using Equation \ref{eq:fleg2}:

\[ \frac{\mathrm{d}^m}{\mathrm{d}x^m}(x^{2k-l}) =
  \begin{cases}
    (2k-l) (2k-l-1) \ldots (2k-l-m+1) x^{2k-l-m}      & \quad \text{if } 2k-l \ge m \\
    0 & \quad \text{if } 2k -l < m
  \end{cases}
\]

Consequently:
\begin{equation*}
    P_{lm}(x)=(-1)^m (1-x^2)^{m/2} \frac{\mathrm{d}^m}{\mathrm{d}x^m} P_l(x) = 
\end{equation*}
\begin{equation*}
     = (-1)^m (1-x^2)^{m/2} \frac{1}{2^l} \sum_{k = \lceil \frac{l+m}{2} \rceil}^{l} (-1)^{l-k} {l \choose k} {2k \choose l} \frac{(2k-l)!}{(2k-l-m)!} x^{2k-l-m}
\end{equation*}

\end{appendix}


\end{document}
